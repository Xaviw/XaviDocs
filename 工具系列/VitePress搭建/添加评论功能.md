# Vitepress æ·»åŠ è¯„è®ºåŠŸèƒ½

åšå®¢æƒ³æ·»åŠ è¯„è®ºåŠŸèƒ½é€šå¸¸æœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. è‡ªå»ºæˆ–ç¬¬ä¸‰æ–¹çš„è¯„è®ºæœåŠ¡
2. åŸºäº Github Issue å®ç°

ä½¿ç”¨ç¬¬ä¸‰æ–¹è¯„è®ºæ¯”è¾ƒæ˜æ˜¾çš„ç¼ºé™·æ˜¯éœ€è¦å¤æ‚çš„æ³¨å†Œè®¤è¯ï¼Œè€Œä¸”ç”¨æˆ·è¯„è®ºæ—¶å¤§æ¦‚ç‡ä¹Ÿéœ€è¦æ³¨å†Œç™»å½•ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæœ‰å¹¿å‘Š

è€ŒåŸºäº Github Issue å®ç°çš„è¯„è®ºåŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å€ŸåŠ©äº Github è´¦å·ç™»å½•å®ç°è¯„è®ºï¼Œè€Œä¸”è¯„è®ºç›´æ¥æ”¾åœ¨ä»“åº“ Issue ä¸­ä¸ªäººè§‰å¾—ä¹Ÿæ›´ç¬¦åˆæŠ€æœ¯åšå®¢çš„å®šä½ã€‚ä½†è¿™ç§æ–¹æ¡ˆä¹Ÿæœ‰ç¼ºé™·ï¼Œå› ä¸º Github è¢«å¢™çš„é—®é¢˜ï¼Œå¯èƒ½ä¼šæœ‰æ— æ³•è®¿é—®çš„æƒ…å†µ

## Beaudar ä»‹ç»

åŸºäº Github Issues çš„è¯„è®ºç³»ç»Ÿï¼Œæ¯”è¾ƒæµè¡Œçš„æœ‰ [Gitment](https://github.com/imsun/gitment) å’Œ [Gitalk](https://github.com/gitalk/gitalk) ã€‚å®ƒä»¬æ˜æ˜¾çš„ç¼ºé™·æ˜¯ï¼Œç”¨æˆ·å°è¯•ç™»å½•è¯„è®ºæ‰€è¦æ±‚çš„æƒé™æ¯”è¾ƒå¤šã€‚åœ¨ç½‘ä¸Šæœ‰ä¸€ç¯‡æ–‡ç« â€”â€”[Gitment çš„å®‰å…¨æ€§äº‰è®® | ç‹¼ç…åšå®¢](https://blog.wolfogre.com/posts/security-problem-of-gitment/)ä¸­æåˆ°ï¼š

> æ— è®ºæ˜¯åœ¨æœ¬åšå®¢è¿˜æ˜¯åœ¨åˆ«çš„ç½‘ç«™ï¼Œå¦‚æœè¯„è®ºç³»ç»Ÿç”¨çš„æ˜¯ Gitmentï¼Œåªè¦ä½ ä¸æ˜¯ç™¾åˆ†ç™¾ä¿¡ä»»ç½‘ç«™æ‰€æœ‰è€…ï¼Œå°±å°½é‡ä¸è¦ç™»å½•å†ç•™è¨€ã€‚

å¦ä¸€ä¸ªæ¯”è¾ƒç«çš„è¯„è®ºç³»ç»Ÿæ˜¯ [Utterances](https://github.com/utterance/utterances)ï¼Œæœ€å¤§çš„åŒºåˆ«åœ¨äº utterances æ‰€éœ€çš„æƒé™å°‘å¾ˆå¤šï¼Œä»…é™äºè¯»å†™ç‰¹å®šä»“åº“çš„ issues å’Œ commentsï¼ŒåŒæ—¶è¿˜å¯¹éƒ¨ç½²è¿›è¡Œäº†ç®€åŒ–

å›½å†…æœ‰ä¸€ä¸ª utterances çš„ä¸­æ–‡ç‰ˆæœ¬ [Beaudar](http://github.com/beaudar/beaudar)ï¼Œä½œè€…å¯¹å…¶çš„ä»‹ç»æ˜¯ï¼š

- å¼€æºã€‚ğŸ“–
- æ²¡æœ‰è¿½è¸ªï¼Œæ²¡æœ‰å¹¿å‘Šï¼Œæ°¸ä¹…å…è´¹ã€‚â™»ï¸
- ä¸ä¿ç•™æ•°æ®ï¼Œæ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ç”¨æˆ· GitHub issue ä¸­ã€‚ğŸ“š
- æœ‰æºäº GitHub primer çš„å¤šä¸ªä¸»é¢˜ã€‚ğŸŒˆ
- è½»é‡åŒ–ï¼Œæ²¡æœ‰å­—ä½“ä¸‹è½½ï¼Œæ²¡æœ‰ JS æ¡†æ¶åŠ è½½ã€‚ğŸœ

Beaudar ä¸ Utterances æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

- ä¸­æ–‡ç•Œé¢ï¼Œæ‹‰è¿‘è·ç¦»å¢åŠ è¯„è®ºå‹å¥½æ€§ã€‚
- å¤´åƒä¿®æ”¹ï¼Œç§»åŠ¨ç«¯æ˜¾ç¤ºå°å¤´åƒæ›´ç²¾è‡´ã€‚
- èº«ä»½æ ‡è¯†ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šæ¢è¡Œã€‚
- è¯„è®ºæ—¶é—´ï¼Œç¼©å°è‡³ä¸èº«ä»½æ ‡è¯†ç›¸åŒå¤§ã€‚
- åç§°æ˜¾ç¤ºï¼Œè¯„è®ºè€…åç§°æ”¾å¤§å¢åŠ è¾¨è¯†ã€‚
- é“¾æ¥æ‰“å¼€ï¼Œä»æ–°æ ‡ç­¾é¡µæ‰“å¼€ç¬¦åˆä¹ æƒ¯ã€‚
- é”™è¯¯ä¿¡æ¯ï¼Œä½¿ç”¨å¯¹è¯æ¡†å½¢å¼å‹å¥½å‘ˆç°ã€‚
- è¯„è®ºå¤´åƒï¼Œå¢åŠ å¯ä»¥ä½¿ç”¨ Tab é”®é€‰ä¸­ã€‚
- åŠ è½½çŠ¶æ€ï¼Œé»˜è®¤åŠ è½½çŠ¶æ€å¯é…ç½®å»é™¤ã€‚
- ç§»é™¤æ¥æºï¼Œç‚¹å‡»åŠ è½½å›¾æ ‡è·³è½¬è‡³ä¸»é¡µã€‚
- åˆ·æ–°é¡µé¢ï¼Œå‡ºç°é”™è¯¯å¼‚å¸¸å¯è¿›è¡Œåˆ·æ–°ã€‚
- ä¿æŒä¸»é¢˜ï¼Œåˆ·æ–°é¡µé¢æ—¶ä¸»é¢˜å°†ä¼šä¿æŒã€‚
- åˆ†æ”¯é€‰é¡¹ï¼Œå¢åŠ ä»“åº“åˆ†æ”¯é¡¹ç”¨äºæ ¡éªŒã€‚
- è¯„è®ºé¡ºåºï¼Œå¯é€‰æŒ‰æ—¶é—´çš„å‡åºæˆ–å€’åºã€‚
- è¯„è®ºä½ç½®ï¼Œå¯è®¾ç½®è¯„è®ºè¾“å…¥æ¡†çš„ä½ç½®ã€‚

æœ¬ç³»ç»Ÿä¾¿é‡‡ç”¨äº† Beaudar æ”¯æŒè¯„è®ºåŠŸèƒ½ï¼Œå¯ä»¥åœ¨æœ¬æ–‡ä¸‹æ–¹ä½“éªŒï¼ˆå¦‚æœæ²¡æœ‰å‡ºç°ï¼Œå°è¯•åˆ·æ–°æˆ–æ£€æŸ¥æ˜¯å¦è¢«å¢™çš„é—®é¢˜ï¼‰

## ä½¿ç”¨

åœ¨ [Beaudarå®˜ç½‘](https://beaudar.lipk.org/) ä¸­æä¾›äº†é…ç½®å¹¶è·å–ä»£ç åŠŸèƒ½ï¼ŒæŒ‰æç¤ºå®Œæˆé…ç½®åå¯ä»¥å¾—åˆ°è¿™æ ·çš„è„šæœ¬ä»£ç ï¼š

```html
<script src="https://beaudar.lipk.org/client.js"
        repo="Xaviw/XaviDocs"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
```

åŠ è½½è¿™æ®µè„šæœ¬åä¼šæ·»åŠ è¯„è®ºç»„ä»¶æ‰€éœ€æ ·å¼åˆ° head å…ƒç´ ä¸­ï¼Œå¹¶è¯»å–è„šæœ¬å±æ€§ä»¥åŠå½“å‰é¡µé¢å±æ€§ï¼Œæ‹¼æ¥å‡ºæœ€ç»ˆçš„ iframe srcï¼Œç„¶åæ·»åŠ  iframe åˆ°è„šæœ¬ä½ç½®å¤„ï¼Œæœ€åä¼šåˆ é™¤è„šæœ¬å…ƒç´ æœ¬èº«

ä½¿ç”¨ Beaudar è¿˜éœ€è¦åœ¨é¡¹ç›®ä»“åº“æ ¹ç›®å½•ä¸‹åˆ›å»º `beaudar.json` æ–‡ä»¶ï¼Œä½œç”¨æ˜¯é™åˆ¶åœ¨å“ªä¸ªåŸŸä¸‹å¯ä»¥å‘å¸ƒè¯„è®ºã€‚å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œå°†åŸŸåæ”¹ä¸ºè‡ªå·±å°†è¦å‘å¸ƒçš„åŸŸåå³å¯

```json
{
  "origins": [
    "https://xaviw.github.io"
  ]
}
```

### å®šä¹‰è¯„è®ºä½ç½®

è¯„è®ºé€šå¸¸åœ¨æ–‡ç« åº•éƒ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é»˜è®¤å¸ƒå±€ç»„ä»¶ Layout çš„ doc-after æ’æ§½æ”¾ç½®è¯„è®ºç»„ä»¶ï¼š

```vue
<!-- Layout.vue -->
<template>
  <Layout>
    <template #doc-after>
      <Comment style="margin-top: 24px;" />
    </template>
  </Layout>
</template>

<script lang="ts" setup>
import DefaultTheme from 'vitepress/theme'
import Comment from './Comment.vue';

const { Layout } = DefaultTheme
</script>

```

æŒ‰ä¸Šé¢ä»£ç å®Œæˆæ–°çš„å¸ƒå±€ç»„ä»¶åï¼ˆå¯ä»¥å¦è¡Œè‡ªå®šä¹‰æˆ–è¿›è¡Œæ‰©å±•ï¼‰ï¼Œå‚è€ƒ[è‡ªå®šä¹‰ä¸»é¢˜](/å·¥å…·ç³»åˆ—/vitepressæ­å»º/é…ç½®è§£æ#è‡ªå®šä¹‰ä¸»é¢˜)å°†è‡ªå®šä¹‰å¸ƒå±€ç»„ä»¶è®¾ç½®ä¸º Layout ç»„ä»¶å³å¯æ­£ç¡®æ¸²æŸ“ Comment ç»„ä»¶

### å¼€å‘ Comment ç»„ä»¶

ä¸Šé¢æåˆ°äº† Beaudar è„šæœ¬åŠ è½½åä¼šè¯»å–é¡µé¢å±æ€§å†åˆ›å»º iframe srcï¼Œè¿™æ˜¯å› ä¸ºæœ€ç»ˆçš„ issue è·¯å¾„æ˜¯æ ¹æ®é¡µé¢è·¯å¾„ç”Ÿæˆçš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ JS æ“ä½œåœ¨åˆ‡æ¢æ–‡ç« æ—¶é‡æ–°åŠ è½½è„šæœ¬

Beaudar é»˜è®¤ä¼šè¯»å–è®¾ç½®çš„æ˜/æš—æ ·å¼å±æ€§æˆ–æµè§ˆå™¨é»˜è®¤æ˜/æš—æ ·å¼ï¼Œä½†åœ¨ vitepress ä¸­åŒæ­¥æ–‡æ¡£çš„æ˜/æš—æ ·å¼ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¯ä»¥é€šè¿‡ç›‘å¬ vitepress æä¾›çš„ isDark å±æ€§ï¼Œå†é€šè¿‡ Beaudar å®˜æ–¹æä¾›çš„ postMessage æ–¹å¼æ¥ä¿®æ”¹æ ·å¼

::: tip
åŒæ­¥ vitepress æ ·å¼åœ¨ Beaudar è¿˜æœªåŠ è½½å®Œæˆæ—¶å¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚å› ä¸º iframe æœªåŠ è½½å®Œæˆæ—¶åˆ‡æ¢æ ·å¼ï¼Œé€šè¿‡ postMessage æ˜¯æ— æ³•ä¼ é€’è¿‡å»çš„

åœ¨æŸ¥çœ‹æºç åå‘ç° Beaudar å†…éƒ¨ä¼šå‘å‡ºä¸€ä¸ª resize æ¶ˆæ¯ï¼Œä½œç”¨æ˜¯è®¡ç®—è¯„è®ºé«˜åº¦å¹¶åŠ¨æ€æ”¹å˜å®¹å™¨é«˜åº¦ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥è§£å†³ä¸Šé¢çš„ bugï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¥æ”¶åˆ° resize æ¶ˆæ¯æ—¶æ­£å¥½æ˜¯ Beaudar åŠ è½½å®Œæˆçš„æ—¶é—´
:::

å®Œæ•´ä»£ç ä¸ºï¼š

```vue
<!-- Comment.vue -->
<script setup lang="ts">
import { inBrowser, useData } from 'vitepress'
import { ref, onMounted, watchEffect, onUnmounted } from 'vue'

const { page, isDark } = useData();

const comments = ref<HTMLElement>();

// éé¦–é¡µæ—¶åŠ è½½è¯„è®ºç»„ä»¶
watchEffect(() => {
  if (page.value.relativePath && page.value.relativePath !== 'index.md') {
    setComments()
  }
})

// ç›‘å¬æ ·å¼ï¼Œå¹¶åŒæ­¥è¯„è®ºç»„ä»¶
watchEffect(setTheme)

// Beaudar é€šè¿‡è¯»å– script ä¸­çš„å±æ€§æ¥è®¾ç½®æ ·å¼
// å¦‚æœ iframe è¿˜æœªåŠ è½½å®Œæˆæ—¶é©¬ä¸Šåˆ‡æ¢æ ·å¼åˆ™æ— æ³•åŒæ­¥æœ€æ–°æ ·å¼ï¼ˆå› ä¸ºæœªåŠ è½½å®Œæˆæ— æ³•é€šä¿¡ï¼‰
// å¯ä»¥åˆ©ç”¨ Beaudar ä¼šé€šè¿‡ postMessage æ¥å‘é€æ‰€å é«˜åº¦çš„ç‰¹æ€§è§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆé¦–æ¬¡æ”¶åˆ°æ¶ˆæ¯å°±åˆšåˆ›å»ºå®Œæˆçš„æ—¶å€™ï¼‰
onMounted(() => {
  window.addEventListener('message', watchMsg)
})

onUnmounted(() => {
  window.removeEventListener('message', watchMsg)
})

function watchMsg(msg: MessageEvent) {
  if (msg.origin === 'https://beaudar.lipk.org') {
    setTheme()
  }
}

function setComments() {
  if (!inBrowser) {
    return
  }
  if (comments?.value) {
    const script = document.createElement('script');
    script.src = 'https://beaudar.lipk.org/client.js';
    // TODOï¼šéœ€è¦æ›´æ¢ä»“åº“åï¼Œå¦‚æœä¸é‡‡ç”¨é»˜è®¤é…ç½®ï¼Œè‡ªè¡Œä¿®æ”¹
    script.setAttribute('repo', 'Xaviw/XaviDocs')
    script.setAttribute('issue-term', 'pathname')
    script.setAttribute('crossorigin', 'anonymous')
    script.setAttribute('label', 'ğŸ’¬è¯„è®º')
    script.async = true;
    comments.value.innerHTML = '';
    comments.value.appendChild(script);
  }
}

function setTheme() {
  if (inBrowser) {
    const message = {
      type: 'set-theme',
      theme: isDark.value ? 'github-dark' : 'github-light',
    };
    const beaudar = document.querySelector<HTMLIFrameElement>('.beaudar iframe');
    if (beaudar?.contentWindow) {
      beaudar.contentWindow.postMessage(
        message,
        'https://beaudar.lipk.org',
      );
    }
  }
}
</script>

<template>
  <section ref="comments"></section>
</template>
```
